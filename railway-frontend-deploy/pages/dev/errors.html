<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visor de Errores (Dev)</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 0; }
    header { padding: 16px; background: #111827; color: #fff; }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 12px 0 20px; }
    input, select, button { padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; }
    button { cursor: pointer; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
    th { text-align: left; background: #f9fafb; position: sticky; top: 0; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .pill { padding: 2px 6px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-weight: 600; font-size: 12px; }
    .wrap { white-space: pre-wrap; word-break: break-word; }
    .muted { color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size: 18px;">Visor de Errores (solo desarrollo)</h1>
  </header>
  <main>
    <div class="controls">
      <label>Fecha: <input type="date" id="date"></label>
      <label>Fechas disponibles:
        <select id="dateList">
          <option value="">(cargar)</option>
        </select>
      </label>
      <label>Límite: 
        <select id="limit">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </label>
      <label>Filtro tipo: 
        <select id="type">
          <option value="">Todos</option>
          <option value="error">error</option>
          <option value="unhandledRejection">unhandledRejection</option>
          <option value="consoleError">consoleError</option>
        </select>
      </label>
      <input id="q" placeholder="Buscar texto..." style="flex:1; min-width: 180px;" />
      <input id="devToken" placeholder="devToken (opcional)" style="min-width: 160px;" />
      <button id="refresh">Actualizar</button>
      <button id="downloadCsv">Descargar CSV</button>
    </div>
    <div class="controls" style="margin-top:-8px;">
      <button id="prev">← Prev</button>
      <button id="next">Next →</button>
      <span id="pageInfo" class="muted"></span>
    </div>

    <div id="summary" class="muted" style="margin: 8px 0;"></div>
    <div style="overflow: auto; max-height: calc(100vh - 220px); border: 1px solid #e5e7eb; border-radius: 8px;">
      <table>
        <thead>
          <tr>
            <th style="width: 180px;">Fecha</th>
            <th style="width: 110px;">Tipo</th>
            <th>Mensaje</th>
            <th style="width: 240px;">Origen</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    const API = typeof __API_URL__ !== 'undefined' ? __API_URL__ : (import.meta.env?.VITE_API_URL || 'http://localhost:3000/api');
    const els = (sel) => document.querySelector(sel);
    const dateEl = els('#date');
    const dateListEl = els('#dateList');
    const limitEl = els('#limit');
    const typeEl = els('#type');
    const qEl = els('#q');
    const devTokenEl = els('#devToken');
    const rowsEl = els('#rows');
    const summaryEl = els('#summary');
    const pageInfoEl = els('#pageInfo');

    let offset = 0;

    // default date = today
    const today = new Date().toISOString().slice(0,10);
    dateEl.value = today;

    function escapeHtml(s) {
      return String(s).replace(/[&<>"]+/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    async function fetchDates() {
      try {
        const url = new URL(`${API}/errors/dates`);
        url.searchParams.set('includeCounts', '1');
        const devToken = devTokenEl.value.trim();
        if (devToken) url.searchParams.set('devToken', devToken);
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        if (!Array.isArray(data.dates)) return;
        dateListEl.innerHTML = data.dates.map((d) => {
          if (typeof d === 'string') return `<option value="${d}">${d}</option>`;
          return `<option value="${d.date}">${d.date} (${d.count})</option>`;
        }).join('');
        // Marcar fecha actual si existe
        const curr = dateEl.value;
        const opt = Array.from(dateListEl.options).find(o => o.value === curr);
        if (opt) dateListEl.value = curr;
      } catch (e) {
        // noop
      }
    }

    async function load() {
      const date = dateEl.value || today;
      const limit = limitEl.value || '50';
      const type = typeEl.value || '';
      const q = qEl.value || '';
      const url = new URL(`${API}/errors/recent`);
      url.searchParams.set('date', date);
      url.searchParams.set('limit', String(limit));
      url.searchParams.set('offset', String(offset));
      if (type) url.searchParams.set('type', type);
      if (q) url.searchParams.set('q', q);
      const devToken = devTokenEl.value.trim();
      if (devToken) url.searchParams.set('devToken', devToken);
      const res = await fetch(url, {
        headers: devToken ? { 'x-dev-token': devToken } : {}
      });
      if (!res.ok) {
        rowsEl.innerHTML = `<tr><td colspan="4">No disponible (status ${res.status}). ¿Está el gateway en desarrollo?</td></tr>`;
        return;
      }
      const data = await res.json();
      const items = (data.entries || [])
        .map((e) => ({
          ts: e.ts || e.timestamp || e.payload?.timestamp,
          type: e.payload?.type || e.payload?.errorType || e.payload?.name || 'error',
          msg: e.payload?.message || e.payload?.errorMessage || e.payload?.error || e.payload?.stack || JSON.stringify(e.payload),
          url: e.url || e.payload?.url || '',
          ua: e.ua || '',
          file: e.payload?.filename || '',
          line: e.payload?.lineno || '',
          col: e.payload?.colno || ''
        }));

      summaryEl.textContent = `${items.length} de ${data.total ?? data.count} entradas (fecha ${data.date})`;
      pageInfoEl.textContent = `offset=${data.offset ?? 0}, limit=${limit}`;

      rowsEl.innerHTML = items.reverse().map((e) => {
        const when = e.ts ? new Date(e.ts).toLocaleString() : '';
        const origin = e.file ? `${e.file}:${e.line || ''}${e.col ? ':'+e.col : ''}` : (e.url || '');
        return `
          <tr>
            <td class="mono">${escapeHtml(when)}</td>
            <td><span class="pill">${escapeHtml(e.type)}</span></td>
            <td class="wrap">${escapeHtml(String(e.msg).slice(0, 500))}</td>
            <td class="wrap mono muted">${escapeHtml(origin)}</td>
          </tr>
        `;
      }).join('');
    }

    els('#refresh').addEventListener('click', () => { offset = 0; load(); });
    [dateEl, limitEl, typeEl].forEach((el) => el.addEventListener('change', () => { offset = 0; load(); }));
    dateListEl.addEventListener('change', () => { dateEl.value = dateListEl.value; offset = 0; load(); });
    qEl.addEventListener('input', () => { clearTimeout(window.__qT); window.__qT = setTimeout(() => { offset = 0; load(); }, 250); });
    devTokenEl.addEventListener('change', () => { offset = 0; fetchDates(); load(); });

    els('#prev').addEventListener('click', () => { const l = parseInt(limitEl.value || '50', 10); offset = Math.max(0, offset + l); load(); });
    els('#next').addEventListener('click', () => { const l = parseInt(limitEl.value || '50', 10); offset = Math.max(0, offset - l); load(); });
    els('#downloadCsv').addEventListener('click', () => {
      const date = dateEl.value || today;
      const limit = limitEl.value || '50';
      const type = typeEl.value || '';
      const q = qEl.value || '';
      const devToken = devTokenEl.value.trim();
      const u = new URL(`${API}/errors/download`);
      u.searchParams.set('format', 'csv');
      u.searchParams.set('date', date);
      if (type) u.searchParams.set('type', type);
      if (q) u.searchParams.set('q', q);
      if (devToken) u.searchParams.set('devToken', devToken);
      // offset no aplica a CSV: devuelve todo lo filtrado del día
      window.open(u.toString(), '_blank');
    });

    fetchDates();
    load();
  </script>
    <script src="/js/components/common-bundle.js" type="module"></script>
</body>
</html>
