# Dockerfile para auth-service - Railway Compatible
# Build version: 2.0.0 - Using local stubs instead of printf
FROM node:22-slim

WORKDIR /app

# Install build tools for bcrypt native module
RUN apt-get update && apt-get install -y python3 make g++ && rm -rf /var/lib/apt/lists/*

# Copy package.json and install dependencies
COPY microservices/auth-service/package*.json ./
RUN npm install --omit=dev --no-audit --no-fund

# Copy auth-service source code
COPY microservices/auth-service/src ./src/

# Create directory structure for shared module
RUN rm -rf node_modules/@flores-victoria 2>/dev/null || true \
    && mkdir -p node_modules/@flores-victoria/shared/logging \
    && mkdir -p node_modules/@flores-victoria/shared/middleware \
    && mkdir -p node_modules/@flores-victoria/shared/errors \
    && mkdir -p node_modules/@flores-victoria/shared/mcp

# Create package.json for shared module with exports field
RUN printf '{\n\
  "name": "@flores-victoria/shared",\n\
  "version": "1.0.0",\n\
  "main": "index.js",\n\
  "exports": {\n\
    ".": "./index.js",\n\
    "./logging": "./logging/index.js",\n\
    "./logging/logger": "./logging/index.js",\n\
    "./middleware/access-log": "./middleware/access-log.js",\n\
    "./middleware/error-handler": "./middleware/error-handler.js",\n\
    "./middleware/security": "./middleware/security.js",\n\
    "./middleware/rate-limiter": "./middleware/rate-limiter.js",\n\
    "./middleware/metrics": "./middleware/metrics.js",\n\
    "./middleware/request-id": "./middleware/request-id.js",\n\
    "./middleware/health-check": "./middleware/health-check.js",\n\
    "./middleware/validation": "./middleware/validation.js",\n\
    "./errors/AppError": "./errors/AppError.js",\n\
    "./mcp": "./mcp/index.js"\n\
  }\n\
}' > node_modules/@flores-victoria/shared/package.json

# Create main index.js
RUN echo 'module.exports = { logger: console };' > node_modules/@flores-victoria/shared/index.js

# Copy stubs from local files (more reliable than printf)
COPY microservices/auth-service/stubs/logging/index.js node_modules/@flores-victoria/shared/logging/index.js
COPY microservices/auth-service/stubs/errors/AppError.js node_modules/@flores-victoria/shared/errors/AppError.js
COPY microservices/auth-service/stubs/middleware/access-log.js node_modules/@flores-victoria/shared/middleware/access-log.js
COPY microservices/auth-service/stubs/middleware/error-handler.js node_modules/@flores-victoria/shared/middleware/error-handler.js
COPY microservices/auth-service/stubs/middleware/security.js node_modules/@flores-victoria/shared/middleware/security.js
COPY microservices/auth-service/stubs/middleware/rate-limiter.js node_modules/@flores-victoria/shared/middleware/rate-limiter.js
COPY microservices/auth-service/stubs/middleware/metrics.js node_modules/@flores-victoria/shared/middleware/metrics.js
COPY microservices/auth-service/stubs/middleware/request-id.js node_modules/@flores-victoria/shared/middleware/request-id.js
COPY microservices/auth-service/stubs/middleware/health-check.js node_modules/@flores-victoria/shared/middleware/health-check.js
COPY microservices/auth-service/stubs/middleware/validation.js node_modules/@flores-victoria/shared/middleware/validation.js
COPY microservices/auth-service/stubs/mcp/index.js node_modules/@flores-victoria/shared/mcp/index.js

# Verify stubs
RUN echo "=== Verifying shared module stubs ===" \
    && ls -la node_modules/@flores-victoria/shared/ \
    && ls -la node_modules/@flores-victoria/shared/middleware/ \
    && cat node_modules/@flores-victoria/shared/logging/index.js | head -5 \
    && echo "=== Stubs verification complete ==="

# Environment variables
ENV NODE_ENV=production
ENV PORT=8080
ENV NODE_OPTIONS="--max-old-space-size=256"

EXPOSE 8080

CMD ["node", "src/server.simple.js"]
