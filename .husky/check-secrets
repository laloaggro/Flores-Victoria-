#!/usr/bin/env bash
# Hook para detectar posibles credenciales antes de commit

# Colores para output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns peligrosos
PATTERNS=(
  "password\s*=\s*['\"](?!.*example|.*placeholder|.*your-|.*changeme)[^'\"]{8,}"
  "api[_-]?key\s*=\s*['\"](?!.*example|.*placeholder|.*your-)[^'\"]{20,}"
  "secret\s*=\s*['\"](?!.*example|.*placeholder|.*your-)[^'\"]{20,}"
  "token\s*=\s*['\"](?!.*example|.*placeholder|.*your-)[^'\"]{20,}"
  "aws_access_key_id\s*=\s*[A-Z0-9]{20}"
  "AKIA[0-9A-Z]{16}"
  "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----"
)

echo "üîç Verificando credenciales en archivos staged..."

# Obtener archivos staged
FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_SECRETS=false

for FILE in $FILES; do
  # Ignorar archivos en .gitignore y directorios seguros
  if [[ "$FILE" =~ node_modules|\.git|dist|build|coverage|\.example$ ]]; then
    continue
  fi
  
  # Verificar cada pattern
  for PATTERN in "${PATTERNS[@]}"; do
    MATCHES=$(git diff --cached "$FILE" | grep -iP "$PATTERN" | grep "^\+" || true)
    
    if [ ! -z "$MATCHES" ]; then
      FOUND_SECRETS=true
      echo -e "${RED}‚ö†Ô∏è  Posible credencial detectada en: $FILE${NC}"
      echo -e "${YELLOW}$MATCHES${NC}"
      echo ""
    fi
  done
done

if [ "$FOUND_SECRETS" = true ]; then
  echo -e "${RED}‚ùå COMMIT BLOQUEADO: Se detectaron posibles credenciales${NC}"
  echo ""
  echo "Si est√°s seguro que no son credenciales reales:"
  echo "  git commit --no-verify -m \"tu mensaje\""
  echo ""
  echo "Si son credenciales reales:"
  echo "  1. Elim√≠nalas del c√≥digo"
  echo "  2. Usa variables de entorno o .env"
  echo "  3. Agrega el archivo a .gitignore"
  exit 1
fi

echo "‚úÖ No se detectaron credenciales"
exit 0
