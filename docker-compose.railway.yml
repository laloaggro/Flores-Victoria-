version: '3.8'

services:
  # Bases de datos - USAR BASES DE DATOS ADMINISTRADAS DE RAILWAY
  # Crear en Railway: New ‚Üí Database ‚Üí PostgreSQL, MongoDB, Redis
  # Descomentar solo si necesitas bases de datos en contenedor (no recomendado para producci√≥n)
  
  # postgres:
  #   image: postgres:15-alpine







































































































































































































































**Estado**: Listo para despliegue de producci√≥n**√öltima actualizaci√≥n**: 26 de noviembre de 2025---- [ ] Dominio personalizado configurado (opcional)- [ ] Logs monitoreados- [ ] SSL/HTTPS funcionando- [ ] Backups autom√°ticos habilitados- [ ] Alertas de uso configuradas- [ ] Healthchecks verificados (todos los servicios healthy)- [ ] CORS actualizado con dominios correctos- [ ] Dominio p√∫blico generado para api-gateway- [ ] Dominio p√∫blico generado para frontend- [ ] Bases de datos conectadas a servicios (Reference Variables)- [ ] Variables de entorno configuradas en todos los servicios- [ ] Bases de datos administradas creadas (PostgreSQL, MongoDB, Redis)## ‚úÖ Checklist de producci√≥n- **Status**: https://railway.statuspage.io- **Discord**: https://discord.gg/railway- **Documentaci√≥n**: https://docs.railway.app## üìû Soporte3. Habilita CDN para frontend2. Considera escalar servicios con m√°s tr√°fico1. Revisa **"Metrics"** de cada servicio### Performance lento:3. Ajusta recursos o limita peticiones2. Identifica servicio con mayor consumo1. **"Settings"** ‚Üí **"Usage"**### Costos inesperados:3. Deben aparecer como "Reference from [database-name]"2. Ve a **"Settings"** ‚Üí **"Service Variables"**1. Verifica que `DATABASE_URL`, `MONGODB_URI`, `REDIS_URL` est√©n inyectadas### Error de conexi√≥n a base de datos:3. Confirma que bases de datos est√©n conectadas2. Verifica variables de entorno1. Revisa logs: **"Deployments"** ‚Üí **"View Logs"**### Servicio no inicia:## üÜò Soluci√≥n de problemas```  retries: 3healthcheck:restart: always```yamlYa configurados en `docker-compose.railway.yml`:### 3. Reintentos autom√°ticos- Ajusta CPU/Memory por servicio- **"Settings"** ‚Üí **"Resources"**Si necesitas m√°s recursos:### 2. Escalar serviciosRailway integra con Cloudflare. Ve a **"Settings"** ‚Üí **"Networking"** ‚Üí **"Enable CDN"**### 1. Habilitar CDN (opcional)## ‚ö° Optimizaciones de producci√≥n2. Selecciona un deployment anterior ‚Üí **"Redeploy"**1. Ve a cualquier servicio ‚Üí **"Deployments"**### Rollback de c√≥digo:2. Selecciona el backup ‚Üí **"Restore"**1. Ve a la base de datos ‚Üí **"Backups"**### Restaurar backup:Railway hace backups diarios de las bases de datos administradas.### Backups autom√°ticos:## üîê Backups y recuperaci√≥n```# Railway redesplegar√° autom√°ticamente en ~5-10 minutosgit push origin maingit commit -m "feat: nueva funcionalidad"git add .# Hacer cambios```bashRailway est√° configurado para redesplegar autom√°ticamente en cada push a `main`:## üîÑ Despliegue continuo- ‚úÖ Soporte por Discord- ‚úÖ Despliegues ilimitados- ‚úÖ Logs ilimitados (retenci√≥n 7 d√≠as)- ‚úÖ Backups diarios de bases de datos- ‚úÖ SSL/TLS autom√°tico### Incluido en el plan:**Total estimado: $9-11 USD/mes** (puede variar seg√∫n tr√°fico)- **Frontend (Nginx)**: ~$1/mes- **Redis administrado**: ~$1/mes- **MongoDB administrado**: ~$2/mes- **PostgreSQL administrado**: ~$2/mes- **6 microservicios**: ~$3-5/mes### Configuraci√≥n recomendada:## üìä Costos estimados- Products: `https://<api-gateway>.up.railway.app/api/products/health`- Auth: `https://<api-gateway>.up.railway.app/api/auth/health`- API Gateway: `https://<api-gateway>.up.railway.app/health`- Frontend: `https://<tu-dominio>.up.railway.app`### URLs a verificar:Todos los servicios tienen healthchecks configurados. Railway los monitorear√° autom√°ticamente.### Healthchecks:## Paso 8: Verificar el despliegue- **"Settings"** ‚Üí **"Usage"** ‚Üí Configura alertas de costo### Alertas:  - Request count  - Network traffic  - Memory usage  - CPU usage- Pesta√±a **"Metrics"** muestra:### M√©tricas:- Pesta√±a **"Deployments"** ‚Üí Clic en el deployment activo ‚Üí **"View Logs"**- Selecciona cualquier servicio### Ver logs en tiempo real:## Paso 7: Monitoreo y logs```CORS_ORIGINS=https://flores-victoria.up.railway.app,https://www.tudominio.com```envDespu√©s de generar el dominio del frontend, actualiza la variable:## Paso 6: Actualizar CORS en API Gateway3. Guarda la URL para configurar el frontend2. **"Settings"** ‚Üí **"Networking"** ‚Üí **"Generate Domain"**1. Abre **"api-gateway"**### API Gateway (para llamadas directas)   - Configura DNS: CNAME ‚Üí `<tu-proyecto>.up.railway.app`   - Ingresa tu dominio (ej: `www.floresvictoria.com`)   - Clic en **"Custom Domain"**4. Opcional: Agregar dominio personalizado:3. Clic en **"Generate Domain"** (obtendr√°s algo como: `flores-victoria.up.railway.app`)2. Ve a **"Settings"** ‚Üí **"Networking"**1. Abre el servicio **"frontend"**### Frontend (principal)## Paso 5: Configurar dominios p√∫blicosRailway inyectar√° autom√°ticamente estas variables con las credenciales correctas.   - Para todos: Redis ‚Üí `REDIS_URL`   - Para product-service: MongoDB ‚Üí `MONGODB_URI`   - Para auth/user/order-service: PostgreSQL ‚Üí `DATABASE_URL`4. Selecciona:3. Clic en **"Reference Variable"**2. Ve a **"Settings"** ‚Üí **"Service Variables"**1. Abre el servicio (ej: auth-service)Para cada microservicio que necesite base de datos:## Paso 4: Conectar bases de datos a servicios**IMPORTANTE**: `DATABASE_URL`, `MONGODB_URI` y `REDIS_URL` se inyectan autom√°ticamente cuando conectas las bases de datos a tus servicios.```CART_SERVICE_URL=http://cart-service:3005ORDER_SERVICE_URL=http://order-service:3004PRODUCT_SERVICE_URL=http://product-service:3009USER_SERVICE_URL=http://user-service:3003AUTH_SERVICE_URL=http://auth-service:3001# URLs de servicios (Railway las resolver√° internamente)SESSION_SECRET=Hfb8+ExOMQ4aCc9nyBhmDXsN/THNFNt/xfn3zwI7VZY6vyE4lK846QnD+BpuLHNEEHtvKAHPHaak4s+7iixxnQ==JWT_SECRET=XzxHZzDH7rXw6skl8qRlTydTdYeNk7urRnQxo5LJniOwEBAgkABXtpHGbMva8KAZNODE_ENV=production# Seguridad```envVe a cada servicio ‚Üí **Variables** ‚Üí **Raw Editor** y pega:### Variables que DEBES agregar manualmente:- `REDIS_URL` (de Redis)- `MONGODB_URI` (de MongoDB)- `DATABASE_URL` (de PostgreSQL)### Variables que Railway genera autom√°ticamente (NO las agregues manualmente):## Paso 3: Configurar variables de entorno   - `REDIS_URL` (la necesitar√°s para todos los servicios)2. Railway generar√°:1. Clic en **"New"** ‚Üí **"Database"** ‚Üí **"Add Redis"**### 2.3 Crear Redis   - `MONGO_URL`   - `MONGODB_URI` (la necesitar√°s para product-service)2. Railway generar√°:1. Clic en **"New"** ‚Üí **"Database"** ‚Üí **"Add MongoDB"**### 2.2 Crear MongoDB   - `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`   - `DATABASE_URL` (la necesitar√°s para los servicios)3. Railway crear√° la base de datos y generar√° estas variables autom√°ticamente:2. Selecciona **"Database"** ‚Üí **"Add PostgreSQL"**1. En tu proyecto Railway, clic en **"New"**### 2.1 Crear PostgreSQL- ‚úÖ Incluidas en el plan- ‚úÖ Mejor rendimiento- ‚úÖ Alta disponibilidad- ‚úÖ Backups autom√°ticos diarios**NO uses las bases de datos en contenedores**. Railway ofrece bases de datos administradas con:## Paso 2: Crear bases de datos administradas (CR√çTICO)  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER:-flores_user}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     POSTGRES_DB: ${POSTGRES_DB:-flores_db}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data

  # mongodb:
  #   image: mongo:7.0
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-flores_admin}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
  #     MONGO_INITDB_DATABASE: ${MONGO_DB:-flores_products}
  #   volumes:
  #     - mongodb_data:/data/db

  # redis:
  #   image: redis:7-alpine
  #   command: redis-server --requirepass ${REDIS_PASSWORD}
  #   volumes:
  #     - redis_data:/data

  # Microservicios
  auth-service:
    build:
      context: .
      dockerfile: microservices/auth-service/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  product-service:
    build:
      context: .
      dockerfile: microservices/product-service/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3009
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  user-service:
    build:
      context: .
      dockerfile: microservices/user-service/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-service:
    build:
      context: .
      dockerfile: microservices/order-service/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  cart-service:
    build:
      context: .
      dockerfile: microservices/cart-service/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3005
      - REDIS_URL=${REDIS_URL}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  api-gateway:
    build:
      context: .
      dockerfile: microservices/api-gateway/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USER_SERVICE_URL=http://user-service:3003
      - PRODUCT_SERVICE_URL=http://product-service:3009
      - ORDER_SERVICE_URL=http://order-service:3004
      - CART_SERVICE_URL=http://cart-service:3005
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - auth-service
      - user-service
      - product-service
      - order-service
      - cart-service

  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - api-gateway

# Vol√∫menes no necesarios si usas bases de datos administradas de Railway
# volumes:
#   postgres_data:
#   mongodb_data:
#   redis_data:
