%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#059669',
    'actorBkg': '#D1FAE5',
    'actorBorder': '#059669',
    'actorTextColor': '#065F46',
    'actorLineColor': '#10B981',
    'signalColor': '#047857',
    'signalTextColor': '#1F2937',
    'labelBoxBkgColor': '#ECFDF5',
    'labelBoxBorderColor': '#6EE7B7',
    'labelTextColor': '#065F46',
    'loopTextColor': '#047857',
    'noteBorderColor': '#34D399',
    'noteBkgColor': '#D1FAE5',
    'noteTextColor': '#065F46',
    'activationBorderColor': '#059669',
    'activationBkgColor': '#A7F3D0',
    'sequenceNumberColor': '#FFFFFF',
    'fontFamily': 'Inter, Segoe UI, Arial, sans-serif',
    'fontSize': '14px'
  },
  'sequence': {
    'diagramMarginX': 60,
    'diagramMarginY': 20,
    'actorMargin': 70,
    'width': 180,
    'height': 80,
    'boxMargin': 15,
    'boxTextMargin': 8,
    'noteMargin': 15,
    'messageMargin': 45,
    'mirrorActors': false,
    'useMaxWidth': false,
    'showSequenceNumbers': true
  }
}}%%

sequenceDiagram
    autonumber

    participant C as ðŸ‘¤<br/>Cliente
    participant FE as ðŸŽ¨<br/>Frontend
    participant GW as ðŸšª<br/>Gateway
    participant CART as ðŸ›’<br/>Cart
    participant PROD as ðŸŒ·<br/>Products
    participant ORD as ðŸ“‹<br/>Orders
    participant PAY as ðŸ’³<br/>Payments
    participant NOT as ðŸ””<br/>Notify
    participant STR as ðŸ’°<br/>Stripe

    Note over C,STR: ðŸ›ï¸ FLUJO COMPLETO DE COMPRA - FLORES VICTORIA

    rect rgb(220, 252, 231)
        Note over C,PROD: ðŸ“¦ FASE 1: AGREGAR AL CARRITO
        C->>+FE: Click "Agregar al carrito"<br/>Ramo de Rosas - $599
        FE->>+GW: POST /api/cart/items<br/>{ productId, quantity: 1 }
        GW->>+CART: Add item request
        CART->>+PROD: GET /products/{id}/stock
        PROD-->>-CART: { stock: 15, available: true }
        CART->>CART: Guardar en Redis<br/>cart:session123
        CART-->>-GW: { cartId, items: 1, subtotal: 599 }
        GW-->>-FE: 200 OK
        FE->>FE: Actualizar badge ðŸ›’(1)
        FE-->>-C: âœ… "Agregado al carrito"
    end

    rect rgb(254, 243, 199)
        Note over C,ORD: ðŸ§¾ FASE 2: CHECKOUT
        C->>+FE: Click "Proceder al pago"
        FE->>+GW: GET /api/cart
        GW->>+CART: Get cart details
        CART-->>-GW: { items, subtotal, shipping }
        GW-->>-FE: Cart summary
        FE-->>C: Mostrar resumen del pedido
        
        C->>+FE: Confirmar direcciÃ³n y mÃ©todo
        FE->>+GW: POST /api/orders<br/>{ cartId, addressId, notes }
        GW->>+ORD: Create order
        ORD->>+CART: Lock cart items
        CART-->>-ORD: Items locked
        ORD->>+PROD: Reserve inventory<br/>{ productId, qty }
        PROD-->>-ORD: Inventory reserved âœ“
        ORD->>ORD: Calculate totals<br/>Subtotal + Shipping - Discount
        ORD-->>-GW: { orderId, total: 649, status: 'pending' }
        GW-->>-FE: Order created
        FE-->>-C: ðŸ“‹ Orden #FV-2024-001 creada
    end

    rect rgb(254, 226, 226)
        Note over C,STR: ðŸ’³ FASE 3: PROCESAMIENTO DE PAGO
        FE->>+GW: POST /api/payments/intent<br/>{ orderId, amount: 649 }
        GW->>+PAY: Create payment intent
        PAY->>+STR: POST /v1/payment_intents<br/>{ amount: 64900, currency: 'mxn' }
        STR-->>-PAY: { clientSecret: 'pi_xxx_secret_xxx' }
        PAY-->>-GW: { clientSecret }
        GW-->>-FE: Payment intent ready
        
        FE->>FE: Renderizar Stripe Elements
        C->>+FE: Ingresar datos de tarjeta<br/>**** **** **** 4242
        FE->>+STR: confirmCardPayment(clientSecret)
        STR->>STR: Procesar pago<br/>3D Secure si aplica
        STR-->>-FE: { status: 'succeeded' }
        
        FE->>+GW: POST /api/payments/confirm<br/>{ paymentIntentId }
        GW->>+PAY: Confirm payment
        PAY->>+ORD: Update order status
        ORD->>ORD: status = 'paid'
        ORD-->>-PAY: Order updated
        PAY-->>-GW: Payment confirmed
        GW-->>-FE: Success
    end

    rect rgb(237, 233, 254)
        Note over C,NOT: ðŸ“¬ FASE 4: CONFIRMACIÃ“N Y NOTIFICACIÃ“N
        ORD->>+PROD: Confirm inventory deduction
        PROD-->>-ORD: Stock updated: 14
        ORD->>+CART: Clear cart
        CART-->>-ORD: Cart cleared
        
        ORD->>+NOT: Send notifications<br/>{ orderId, userId, email }
        NOT->>NOT: Generate email HTML<br/>ðŸ“§ ConfirmaciÃ³n de pedido
        NOT-->>C: ðŸ“§ Email: "Tu pedido estÃ¡ confirmado"
        NOT->>NOT: Generate SMS
        NOT-->>C: ðŸ“± SMS: "Pedido FV-2024-001 confirmado"
        NOT-->>-ORD: Notifications sent
        
        ORD-->>GW: Order complete
        GW-->>FE: { orderId, status: 'confirmed' }
        FE->>FE: Mostrar confetti ðŸŽ‰
        FE-->>-C: âœ… Â¡Compra exitosa!<br/>Gracias por tu compra
    end

    Note over C,STR: ðŸšš POST-COMPRA: SEGUIMIENTO

    rect rgb(243, 232, 255)
        C->>+FE: Ver estado del pedido
        FE->>+GW: GET /api/orders/FV-2024-001
        GW->>+ORD: Get order details
        ORD-->>-GW: { status: 'preparing', eta: '2h' }
        GW-->>-FE: Order status
        FE-->>-C: ðŸ“¦ "Tu pedido estÃ¡ siendo preparado"<br/>Entrega estimada: 2 horas
    end
