%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#9333EA',
    'actorBkg': '#F3E8FF',
    'actorBorder': '#9333EA',
    'actorTextColor': '#581C87',
    'actorLineColor': '#A855F7',
    'signalColor': '#7C3AED',
    'signalTextColor': '#1F2937',
    'labelBoxBkgColor': '#FAF5FF',
    'labelBoxBorderColor': '#C084FC',
    'labelTextColor': '#581C87',
    'loopTextColor': '#6B21A8',
    'noteBorderColor': '#E879F9',
    'noteBkgColor': '#FDF4FF',
    'noteTextColor': '#701A75',
    'activationBorderColor': '#9333EA',
    'activationBkgColor': '#E9D5FF',
    'sequenceNumberColor': '#FFFFFF',
    'fontFamily': 'Inter, Segoe UI, Arial, sans-serif',
    'fontSize': '14px'
  },
  'sequence': {
    'diagramMarginX': 60,
    'diagramMarginY': 20,
    'actorMargin': 80,
    'width': 200,
    'height': 80,
    'boxMargin': 15,
    'boxTextMargin': 8,
    'noteMargin': 15,
    'messageMargin': 45,
    'mirrorActors': false,
    'bottomMarginAdj': 10,
    'useMaxWidth': false,
    'rightAngles': false,
    'showSequenceNumbers': true
  }
}}%%

sequenceDiagram
    autonumber

    participant C as üë§<br/>Cliente
    participant FE as üé®<br/>Frontend
    participant GW as üö™<br/>API Gateway
    participant AUTH as üîê<br/>Auth Service
    participant DB as üêò<br/>PostgreSQL
    participant CACHE as ‚ö°<br/>Redis

    Note over C,CACHE: üîë FLUJO DE AUTENTICACI√ìN - LOGIN

    rect rgb(243, 232, 255)
        Note right of C: üìù Fase 1: Solicitud de Login
        C->>+FE: Ingresa email y contrase√±a
        FE->>FE: Validaci√≥n client-side
        FE->>+GW: POST /api/auth/login<br/>{ email, password }
        GW->>GW: ‚úì Rate Limiting Check
        GW->>GW: ‚úì Input Sanitization
    end

    rect rgb(233, 213, 255)
        Note right of GW: üîç Fase 2: Verificaci√≥n
        GW->>+AUTH: Forward Request
        AUTH->>+DB: SELECT * FROM users<br/>WHERE email = ?
        DB-->>-AUTH: User Record + Password Hash
        AUTH->>AUTH: bcrypt.compare()<br/>Verificar contrase√±a
    end

    alt ‚úÖ Credenciales V√°lidas
        rect rgb(220, 252, 231)
            Note right of AUTH: üé´ Fase 3: Generaci√≥n de Token
            AUTH->>AUTH: Generar JWT Token<br/>{ userId, role, exp }
            AUTH->>+CACHE: SET session:userId<br/>TTL: 24h
            CACHE-->>-AUTH: OK
            AUTH->>+DB: UPDATE users<br/>SET last_login = NOW()
            DB-->>-AUTH: Updated
            AUTH-->>-GW: 200 OK<br/>{ token, user, expiresIn }
            GW-->>-FE: Response + Set-Cookie
            FE->>FE: localStorage.setItem('token')
            FE-->>-C: ‚úÖ Redirect to Dashboard
        end
    else ‚ùå Credenciales Inv√°lidas
        rect rgb(254, 226, 226)
            AUTH->>+DB: Log failed attempt
            DB-->>-AUTH: Logged
            AUTH-->>GW: 401 Unauthorized<br/>{ error: 'Invalid credentials' }
            GW-->>FE: Error Response
            FE-->>C: ‚ùå Mostrar error<br/>"Email o contrase√±a incorrectos"
        end
    end

    Note over C,CACHE: üîí ACCESO A RECURSOS PROTEGIDOS

    rect rgb(243, 232, 255)
        C->>+FE: Solicita p√°gina protegida
        FE->>FE: Obtener token de storage
        FE->>+GW: GET /api/users/profile<br/>Authorization: Bearer {JWT}
        GW->>GW: ‚úì Verificar firma JWT
        GW->>GW: ‚úì Validar expiraci√≥n
        GW->>+CACHE: GET session:userId
        CACHE-->>-GW: Session v√°lida ‚úì
        GW->>+AUTH: Forward con userId
        AUTH->>+DB: SELECT profile FROM users
        DB-->>-AUTH: User Profile Data
        AUTH-->>-GW: Profile Response
        GW-->>-FE: 200 OK { user }
        FE-->>-C: üìã Mostrar perfil
    end

    Note over C,CACHE: üö™ CIERRE DE SESI√ìN (LOGOUT)

    rect rgb(254, 249, 195)
        C->>+FE: Click "Cerrar sesi√≥n"
        FE->>+GW: POST /api/auth/logout<br/>Authorization: Bearer {JWT}
        GW->>+AUTH: Logout request
        AUTH->>+CACHE: DEL session:userId
        CACHE-->>-AUTH: Deleted
        AUTH->>AUTH: Add token to blacklist
        AUTH-->>-GW: 200 OK
        GW-->>-FE: Session terminated
        FE->>FE: localStorage.clear()
        FE-->>-C: üëã Redirect to login
    end
