%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#8B5CF6', 'actorBkg': '#F3E8FF', 'actorBorder': '#7C3AED', 'signalColor': '#6D28D9', 'signalTextColor': '#1F2937'}}}%%
sequenceDiagram
    autonumber
    participant C as ðŸ‘¤ Cliente
    participant FE as ðŸŽ¨ Frontend
    participant GW as ðŸšª API Gateway
    participant AUTH as ðŸ” Auth Service
    participant PG as ðŸ˜ PostgreSQL
    participant REDIS as âš¡ Redis

    Note over C,REDIS: ðŸ”‘ Flujo de AutenticaciÃ³n - Login

    C->>FE: Ingresa credenciales
    FE->>GW: POST /api/auth/login
    GW->>GW: Rate Limiting Check
    GW->>AUTH: Forward Request
    AUTH->>PG: SELECT user WHERE email = ?
    PG-->>AUTH: User Data + Hash
    AUTH->>AUTH: bcrypt.compare(password, hash)
    
    alt Credenciales VÃ¡lidas
        AUTH->>AUTH: Generate JWT Token
        AUTH->>REDIS: SET session:{userId}
        AUTH-->>GW: 200 OK + JWT + User
        GW-->>FE: Response
        FE->>FE: localStorage.setItem('token')
        FE-->>C: âœ… Redirect to Dashboard
    else Credenciales InvÃ¡lidas
        AUTH-->>GW: 401 Unauthorized
        GW-->>FE: Error Response
        FE-->>C: âŒ Error Message
    end

    Note over C,REDIS: ðŸ”’ Requests Autenticados

    C->>FE: Accede a pÃ¡gina protegida
    FE->>GW: GET /api/users/profile<br/>Header: Authorization: Bearer {JWT}
    GW->>GW: Verify JWT Signature
    GW->>REDIS: Check token not revoked
    REDIS-->>GW: Token Valid
    GW->>AUTH: Forward with userId
    AUTH->>PG: SELECT * FROM users WHERE id = ?
    PG-->>AUTH: User Profile
    AUTH-->>GW: User Data
    GW-->>FE: 200 OK + Profile
    FE-->>C: Display Profile
