name: üöÄ Port-Aware Multi-Environment Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  validate-ports:
    name: üîç Port Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      
      - name: Validate ports
        run: |
          npm run ports:check
          npm run ports:show:dev
          npm run ports:show:prod
          npm run ports:show:test

  test-services:
    name: üß™ Service Tests
    runs-on: ubuntu-latest
    needs: validate-ports
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - run: npm ci
      
      - name: Start dev services
        run: npm run services:start:dev &
      
      - name: Wait for services
        run: sleep 10
      
      - name: Health checks
        run: |
          curl -f http://localhost:3013/health
          curl -f http://localhost:3004/health
          curl -f http://localhost:3021/health
      
      - name: Stop services
        if: always()
        run: npm run services:stop:dev || true

  build-docker:
    name: üê≥ Build Images
    runs-on: ubuntu-latest
    needs: test-services
    strategy:
      matrix:
        service: [ai-service, order-service, auth-service, payment-service]
    
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.${{ matrix.service }}
          tags: flores-victoria/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
