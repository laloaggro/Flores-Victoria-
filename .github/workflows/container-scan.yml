name: Container Image Scan

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1' # Weekly on Mondays at 03:00

jobs:
  build-and-scan:
    name: Build & Scan (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api-gateway
            context: microservices/api-gateway
            dockerfile: Dockerfile
          - service: auth-service
            context: microservices/auth-service
            dockerfile: Dockerfile
          - service: product-service
            context: microservices/product-service
            dockerfile: Dockerfile
          - service: user-service
            context: microservices/user-service
            dockerfile: Dockerfile
          - service: order-service
            context: microservices/order-service
            dockerfile: Dockerfile
          - service: cart-service
            context: microservices/cart-service
            dockerfile: Dockerfile
          - service: wishlist-service
            context: microservices/wishlist-service
            dockerfile: Dockerfile
          - service: review-service
            context: microservices/review-service
            dockerfile: Dockerfile
          - service: contact-service
            context: microservices/contact-service
            dockerfile: Dockerfile
          - service: promotion-service
            context: microservices/promotion-service
            dockerfile: Dockerfile
          - service: frontend
            context: frontend
            dockerfile: Dockerfile
          - service: admin-panel
            context: admin-panel
            dockerfile: Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=${{ github.repository_owner }}/flores-${{ matrix.service }}:${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Build image (${{ matrix.service }})
        run: |
          docker build \
            -f ${{ matrix.context }}/${{ matrix.dockerfile }} \
            -t ${{ steps.meta.outputs.tag }} \
            ${{ matrix.context }}

      - name: Trivy scan (HIGH,CRITICAL)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tag }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: Export Trivy results (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tag }}
          format: 'json'
          output: 'trivy-${{ matrix.service }}.json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.service }}
          path: trivy-${{ matrix.service }}.json
          retention-days: 14
