apiVersion: 1

groups:
  - orgId: 1
    name: flores-victoria-alerts
    folder: Alerts
    interval: 1m
    rules:
      # 1. High CPU Usage Alert
      - uid: high-cpu-usage
        title: High CPU Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'High CPU usage detected on {{ $labels.instance }}'
          description: 'CPU usage is above 80% (current: {{ $value }}%)'
        labels:
          severity: warning
          service: system

      # 2. High Memory Usage Alert
      - uid: high-memory-usage
        title: High Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'High memory usage on {{ $labels.instance }}'
          description: 'Memory usage is above 85% (current: {{ $value }}%)'
        labels:
          severity: warning
          service: system

      # 3. Service Down Alert
      - uid: service-down
        title: Service Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up == 0
              refId: A
        noDataState: Alerting
        execErrState: Error
        for: 2m
        annotations:
          summary: 'Service {{ $labels.job }} is down'
          description: '{{ $labels.instance }} has been down for more than 2 minutes'
        labels:
          severity: critical
          service: '{{ $labels.job }}'

      # 4. High Error Rate Alert
      - uid: high-error-rate
        title: High Error Rate
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'High error rate detected on {{ $labels.instance }}'
          description: 'Error rate is above 5% (current: {{ $value }}%)'
        labels:
          severity: warning
          service: api

      # 5. Slow Response Time Alert
      - uid: slow-response-time
        title: Slow Response Time (P95)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)) > 2
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'Slow response time on {{ $labels.service }}'
          description: 'P95 response time is above 2s (current: {{ $value }}s)'
        labels:
          severity: warning
          service: '{{ $labels.service }}'

      # 6. Database Connection Pool Exhausted
      - uid: db-pool-exhausted
        title: Database Connection Pool Exhausted
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: mongodb_connections_available < 10
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          summary: 'Database connection pool nearly exhausted on {{ $labels.instance }}'
          description: 'Less than 10 connections available (current: {{ $value }})'
        labels:
          severity: critical
          service: database

      # 7. MongoDB Replica Set Member Down
      - uid: mongodb-replica-down
        title: MongoDB Replica Set Member Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: mongodb_replset_member_health != 1
              refId: A
        noDataState: Alerting
        execErrState: Error
        for: 2m
        annotations:
          summary: 'MongoDB replica member {{ $labels.name }} is down'
          description: 'Replica set member health is not OK'
        labels:
          severity: critical
          service: mongodb

      # 8. Redis Memory Usage High
      - uid: redis-memory-high
        title: Redis Memory Usage High
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 90
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'Redis memory usage is high on {{ $labels.instance }}'
          description: 'Redis memory usage is above 90% (current: {{ $value }}%)'
        labels:
          severity: warning
          service: redis

      # 9. Disk Space Low
      - uid: disk-space-low
        title: Disk Space Low
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'Low disk space on {{ $labels.instance }}'
          description: 'Available disk space is below 15% (current: {{ $value }}%)'
        labels:
          severity: warning
          service: system

      # 10. API Gateway High Latency
      - uid: api-gateway-latency
        title: API Gateway High Latency
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service="api-gateway"}[5m])) by (le)) > 3
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: 'API Gateway latency is high'
          description: 'P99 latency is above 3s (current: {{ $value }}s)'
        labels:
          severity: warning
          service: api-gateway
