# Prometheus Alerting Rules for Flores Victoria
# ==============================================
# ConfiguraciÃ³n de alertas para monitoreo proactivo

groups:
  # ========================================
  # Service Health Alerts
  # ========================================
  - name: service_health
    rules:
      # Servicio caÃ­do
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ðŸš¨ Servicio {{ $labels.job }} estÃ¡ caÃ­do"
          description: "El servicio {{ $labels.instance }} no responde desde hace mÃ¡s de 1 minuto."

      # Health check fallando
      - alert: HealthCheckFailing
        expr: probe_success == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ðŸ¥ Health check fallando para {{ $labels.instance }}"
          description: "El health check de {{ $labels.job }} estÃ¡ fallando."

      # Servicio reiniciÃ¡ndose frecuentemente
      - alert: HighRestartRate
        expr: changes(process_start_time_seconds[1h]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ”„ Servicio {{ $labels.job }} reiniciÃ¡ndose frecuentemente"
          description: "El servicio ha reiniciado {{ $value }} veces en la Ãºltima hora."

  # ========================================
  # HTTP/API Alerts
  # ========================================
  - name: http_alerts
    rules:
      # Alta tasa de errores HTTP 5xx
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (job)
          /
          sum(rate(http_requests_total[5m])) by (job)
          > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ðŸ”¥ Alta tasa de errores HTTP 5xx en {{ $labels.job }}"
          description: "MÃ¡s del 5% de las requests estÃ¡n fallando con errores 5xx. Tasa actual: {{ $value | humanizePercentage }}"

      # Alta tasa de errores HTTP 4xx
      - alert: HighClientErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"4.."}[5m])) by (job)
          /
          sum(rate(http_requests_total[5m])) by (job)
          > 0.20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ Alta tasa de errores HTTP 4xx en {{ $labels.job }}"
          description: "MÃ¡s del 20% de las requests estÃ¡n fallando con errores 4xx. Tasa actual: {{ $value | humanizePercentage }}"

      # Latencia alta
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job))
          > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ¢ Latencia alta en {{ $labels.job }}"
          description: "El percentil 95 de latencia estÃ¡ por encima de 2 segundos: {{ $value | humanizeDuration }}"

      # Latencia muy alta (crÃ­tico)
      - alert: VeryHighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job))
          > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ðŸš¨ Latencia crÃ­tica en {{ $labels.job }}"
          description: "El percentil 95 de latencia estÃ¡ por encima de 5 segundos: {{ $value | humanizeDuration }}"

  # ========================================
  # Resource Usage Alerts
  # ========================================
  - name: resource_alerts
    rules:
      # Alto uso de CPU
      - alert: HighCpuUsage
        expr: |
          (
            sum(rate(process_cpu_seconds_total[5m])) by (job)
            * 100
          ) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ’» Alto uso de CPU en {{ $labels.job }}"
          description: "El uso de CPU estÃ¡ por encima del 80%: {{ $value }}%"

      # Uso crÃ­tico de CPU
      - alert: CriticalCpuUsage
        expr: |
          (
            sum(rate(process_cpu_seconds_total[5m])) by (job)
            * 100
          ) > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ðŸ”¥ Uso crÃ­tico de CPU en {{ $labels.job }}"
          description: "El uso de CPU estÃ¡ por encima del 95%: {{ $value }}%"

      # Alto uso de memoria
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes
            /
            node_memory_MemTotal_bytes
          ) * 100 > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ§  Alto uso de memoria en {{ $labels.job }}"
          description: "El uso de memoria estÃ¡ por encima del 80%: {{ $value }}%"

      # Memoria crÃ­tica
      - alert: CriticalMemoryUsage
        expr: |
          (
            process_resident_memory_bytes
            /
            node_memory_MemTotal_bytes
          ) * 100 > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ðŸš¨ Uso crÃ­tico de memoria en {{ $labels.job }}"
          description: "El uso de memoria estÃ¡ por encima del 95%: {{ $value }}%"

  # ========================================
  # Database Alerts
  # ========================================
  - name: database_alerts
    rules:
      # PostgreSQL conexiones altas
      - alert: PostgresConnectionsHigh
        expr: |
          pg_stat_database_numbackends
          /
          pg_settings_max_connections
          > 0.80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ—„ï¸ Conexiones PostgreSQL altas"
          description: "Se estÃ¡n usando mÃ¡s del 80% de las conexiones disponibles: {{ $value | humanizePercentage }}"

      # MongoDB conexiones altas
      - alert: MongoConnectionsHigh
        expr: |
          mongodb_connections{state="current"}
          /
          mongodb_connections{state="available"}
          > 0.80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸƒ Conexiones MongoDB altas"
          description: "Se estÃ¡n usando mÃ¡s del 80% de las conexiones disponibles: {{ $value | humanizePercentage }}"

      # Redis conexiones altas
      - alert: RedisConnectionsHigh
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "âš¡ Conexiones Redis altas"
          description: "Hay {{ $value }} clientes conectados a Redis."

      # Redis memoria alta
      - alert: RedisMemoryHigh
        expr: |
          redis_memory_used_bytes
          /
          redis_memory_max_bytes
          > 0.80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "âš¡ Memoria Redis alta"
          description: "Redis estÃ¡ usando mÃ¡s del 80% de la memoria asignada: {{ $value | humanizePercentage }}"

  # ========================================
  # Authentication Alerts
  # ========================================
  - name: auth_alerts
    rules:
      # Muchos intentos de login fallidos
      - alert: HighLoginFailureRate
        expr: |
          sum(rate(auth_login_failures_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ” Alta tasa de logins fallidos"
          description: "Se detectaron {{ $value }} intentos de login fallidos por segundo. Posible ataque de fuerza bruta."

      # Tasa de registro sospechosa
      - alert: SuspiciousRegistrationRate
        expr: |
          sum(rate(auth_user_registrations_total[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ‘¤ Tasa de registro sospechosa"
          description: "Se detectaron {{ $value }} registros por segundo. Verificar si es spam."

  # ========================================
  # Business Metrics Alerts
  # ========================================
  - name: business_alerts
    rules:
      # Sin ventas en mucho tiempo
      - alert: NoSalesActivity
        expr: |
          sum(increase(orders_total[1h])) == 0
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: "ðŸ’° Sin actividad de ventas"
          description: "No se han registrado ventas en las Ãºltimas 2 horas."

      # Bajo stock en productos
      - alert: LowProductStock
        expr: product_stock_count < 5
        for: 30m
        labels:
          severity: info
        annotations:
          summary: "ðŸ“¦ Stock bajo para {{ $labels.product_name }}"
          description: "El producto tiene solo {{ $value }} unidades en stock."

      # Carrito abandonado rate alto
      - alert: HighCartAbandonmentRate
        expr: |
          sum(rate(cart_abandoned_total[1h]))
          /
          sum(rate(cart_created_total[1h]))
          > 0.70
        for: 1h
        labels:
          severity: info
        annotations:
          summary: "ðŸ›’ Alta tasa de abandono de carritos"
          description: "El {{ $value | humanizePercentage }} de los carritos estÃ¡n siendo abandonados."

  # ========================================
  # Rate Limiting Alerts
  # ========================================
  - name: rate_limit_alerts
    rules:
      # Muchas requests bloqueadas por rate limiting
      - alert: HighRateLimitBlocks
        expr: |
          sum(rate(rate_limit_requests_blocked_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ðŸš« Alto nÃºmero de requests bloqueadas por rate limiting"
          description: "Se estÃ¡n bloqueando {{ $value }} requests por segundo. Posible ataque DDoS o mal uso de API."

  # ========================================
  # Certificate/SSL Alerts
  # ========================================
  - name: ssl_alerts
    rules:
      # Certificado prÃ³ximo a expirar
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "ðŸ”’ Certificado SSL expirando pronto"
          description: "El certificado SSL de {{ $labels.instance }} expira en menos de 30 dÃ­as."

      # Certificado a punto de expirar
      - alert: SSLCertificateExpiringCritical
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "ðŸš¨ Certificado SSL expira en menos de 7 dÃ­as"
          description: "El certificado SSL de {{ $labels.instance }} expira en menos de 7 dÃ­as. Â¡Renovar inmediatamente!"
